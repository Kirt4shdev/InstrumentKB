generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ARTÍCULO SAP - Entidad principal unificada
// =====================================================
// Cualquier cosa que venga de SAP es un artículo
// article_type: Tipo principal (obligatorio)
// category: Sub-clasificación específica (opcional)

enum ArticleType {
  INSTRUMENTO
  CABLE
  SOPORTE
  APARAMENTA_AC
  APARAMENTA_DC
  SENSOR
  ACTUADOR
  DATALOGGER
  FUENTE_ALIMENTACION
  MODULO_IO
  GATEWAY
  CAJA_CONEXIONES
  RACK
  PANEL
  PROTECCION
  CONECTOR
  HERRAMIENTA
  CONSUMIBLE
  REPUESTO
  SOFTWARE
  LICENCIA
  OTROS
}

model Article {
  article_id       String       @id
  sap_itemcode     String?      @unique
  sap_description  String
  article_type     ArticleType  // OBLIGATORIO - Tipo principal del artículo
  category         String?      // OPCIONAL - Sub-clasificación específica
  family           String?
  subfamily        String?
  
  // Campos genéricos aplicables a cualquier artículo
  manufacturer_id  Int?
  model            String?
  variant          String?
  
  // Especificaciones técnicas generales
  power_supply_min_v   Float?
  power_supply_max_v   Float?
  power_consumption_typ_w Float?
  current_max_a        Float?
  voltage_rating_v     Float?
  
  // Características físicas
  ip_rating            String?
  dimensions_mm        String?
  weight_g             Float?
  length_m             Float?      // Para cables
  diameter_mm          Float?      // Para cables
  material             String?
  color                String?
  
  // Condiciones ambientales
  oper_temp_min_c      Float?
  oper_temp_max_c      Float?
  storage_temp_min_c   Float?
  storage_temp_max_c   Float?
  oper_humidity_min_pct Float?
  oper_humidity_max_pct Float?
  altitude_max_m       Float?
  
  // Certificaciones y normativas
  emc_compliance       String?
  certifications       String?     // CE, UL, ATEX, etc.
  
  // Ciclo de vida
  first_release_year   Int?
  last_revision_year   Int?
  discontinued         Boolean     @default(false)
  replacement_article_id String?
  
  // Gestión
  internal_notes   String?
  active           Boolean      @default(true)
  stock_location   String?
  min_stock        Int?
  current_stock    Int?
  
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  // Relaciones
  manufacturer       Manufacturer?         @relation(fields: [manufacturer_id], references: [manufacturer_id], onDelete: SetNull)
  documents          Document[]
  images             Image[]
  article_variables  ArticleVariable[]
  analog_outputs     AnalogOutput[]
  digital_io         DigitalIO[]
  article_protocols  ArticleProtocol[]
  modbus_registers   ModbusRegister[]
  sdi12_commands     SDI12Command[]
  nmea_sentences     NMEASentence[]
  tags               Tag[]
  provenance         Provenance[]
  replacement_for    Article?              @relation("ReplacementArticle", fields: [replacement_article_id], references: [article_id], onDelete: SetNull)
  replaced_by        Article[]             @relation("ReplacementArticle")

  @@index([article_type])
  @@index([category])
  @@index([manufacturer_id])
  @@index([active])
  @@index([family])
  @@index([discontinued])
  @@map("articles")
}

model Manufacturer {
  manufacturer_id Int       @id @default(autoincrement())
  name            String    @unique
  country         String?
  website         String?
  support_email   String?
  notes           String?
  articles        Article[]

  @@map("manufacturers")
}

enum DocumentType {
  datasheet
  manual
  quickstart
  appnote
  firmware
  catalog
  certificate
  drawing
  specification
  other
}

model Document {
  document_id   Int          @id @default(autoincrement())
  article_id    String
  type          DocumentType
  title         String
  language      String?
  revision      String?
  publish_date  DateTime?
  url_or_path   String
  sha256        String?
  notes         String?

  article               Article          @relation(fields: [article_id], references: [article_id], onDelete: Cascade)
  modbus_register_refs  ModbusRegister[] @relation("DocumentReference")
  sdi12_command_refs    SDI12Command[]   @relation("DocumentReference")
  nmea_sentence_refs    NMEASentence[]   @relation("DocumentReference")
  provenance_refs       Provenance[]     @relation("DocumentReference")

  @@map("documents")
}

model Image {
  image_id    Int     @id @default(autoincrement())
  article_id  String
  caption     String?
  url_or_path String
  credit      String?
  license     String?
  notes       String?

  article Article @relation(fields: [article_id], references: [article_id], onDelete: Cascade)

  @@map("images")
}

model VariableDict {
  variable_id      Int                 @id @default(autoincrement())
  name             String              @unique
  unit_default     String?
  description      String?
  article_variables ArticleVariable[]

  @@map("variables_dict")
}

model ArticleVariable {
  art_var_id       Int     @id @default(autoincrement())
  article_id       String
  variable_id      Int
  range_min        Float?
  range_max        Float?
  unit             String?
  accuracy_abs     Float?
  accuracy_rel_pct Float?
  resolution       Float?
  update_rate_hz   Float?
  notes            String?

  article  Article      @relation(fields: [article_id], references: [article_id], onDelete: Cascade)
  variable VariableDict @relation(fields: [variable_id], references: [variable_id])

  @@unique([article_id, variable_id])
  @@map("article_variables")
}

enum AnalogOutputType {
  Current_4_20mA
  Voltage_0_10V
  Pulse
  Relay
  TTL
  Other
}

model AnalogOutput {
  analog_out_id Int               @id @default(autoincrement())
  article_id    String
  type          AnalogOutputType
  num_channels  Int?
  range_min     Float?
  range_max     Float?
  unit          String?
  load_min_ohm  Float?
  load_max_ohm  Float?
  accuracy      String?
  scaling_notes String?

  article Article @relation(fields: [article_id], references: [article_id], onDelete: Cascade)

  @@map("analog_outputs")
}

enum IODirection {
  input
  output
}

enum SignalType {
  Current_4_20mA
  Voltage_0_10V
  Pulse
  Relay
  TTL
  Other
}

model DigitalIO {
  dio_id         Int          @id @default(autoincrement())
  article_id     String
  direction      IODirection
  signal_type    SignalType
  voltage_level  String?
  current_max_ma Float?
  frequency_max_hz Float?
  notes          String?

  article Article @relation(fields: [article_id], references: [article_id], onDelete: Cascade)

  @@map("digital_io")
}

enum ProtocolType {
  ModbusRTU
  ModbusTCP
  SDI12
  NMEA0183
  CANopen
  Profinet
  EthernetIP
  RS232
  RS485
  Other
}

enum Parity {
  N
  E
  O
}

model ArticleProtocol {
  art_proto_id   Int          @id @default(autoincrement())
  article_id     String
  type           ProtocolType
  physical_layer String?
  port_label     String?
  default_address String?
  baudrate       Int?
  databits       Int?
  parity         Parity?
  stopbits       Int?
  ip_address     String?
  ip_port        Int?
  notes          String?

  article Article @relation(fields: [article_id], references: [article_id], onDelete: Cascade)

  @@map("article_protocols")
}

enum ReadWrite {
  R
  W
  RW
}

model ModbusRegister {
  modbus_id             Int       @id @default(autoincrement())
  article_id            String
  function_code         Int
  address               Int
  name                  String
  description           String?
  datatype              String?
  scale                 Float?
  unit                  String?
  rw                    ReadWrite
  min                   Float?
  max                   Float?
  default_value         String?
  notes                 String?
  reference_document_id Int?

  article            Article   @relation(fields: [article_id], references: [article_id], onDelete: Cascade)
  reference_document Document? @relation("DocumentReference", fields: [reference_document_id], references: [document_id])

  @@unique([article_id, function_code, address])
  @@map("modbus_registers")
}

model SDI12Command {
  sdi12_id              Int     @id @default(autoincrement())
  article_id            String
  command               String
  description           String?
  response_format       String?
  reference_document_id Int?

  article            Article   @relation(fields: [article_id], references: [article_id], onDelete: Cascade)
  reference_document Document? @relation("DocumentReference", fields: [reference_document_id], references: [document_id])

  @@unique([article_id, command])
  @@map("sdi12_commands")
}

model NMEASentence {
  nmea_id               Int     @id @default(autoincrement())
  article_id            String
  sentence              String
  description           String?
  fields                String?
  reference_document_id Int?

  article            Article   @relation(fields: [article_id], references: [article_id], onDelete: Cascade)
  reference_document Document? @relation("DocumentReference", fields: [reference_document_id], references: [document_id])

  @@unique([article_id, sentence])
  @@map("nmea_sentences")
}

model Tag {
  tag_id     Int    @id @default(autoincrement())
  article_id String
  tag        String

  article Article @relation(fields: [article_id], references: [article_id], onDelete: Cascade)

  @@map("tags")
}

model Provenance {
  prov_id            Int     @id @default(autoincrement())
  table_name         String
  record_id          Int
  field_name         String?
  source_document_id Int?
  page               String?
  quote_or_note      String?
  article_id         String

  article         Article   @relation(fields: [article_id], references: [article_id], onDelete: Cascade)
  source_document Document? @relation("DocumentReference", fields: [source_document_id], references: [document_id])

  @@map("provenance")
}
